<html>
<head>
    <meta charset="UTF-8"/>
    <title>ChimeraUI</title>
    <link rel="stylesheet" href="assets/css/style.css"/>
    <link rel="stylesheet" href="assets/css/topbar.css"/>
    <script defer src="assets/js/renderer.js"></script>
</head>
<body>
<div id="controls">
    <button id="home" title="Go Home">Home</button>
    <button id="record-button" class="idle" title="Start recording">‚è∫ Start</button>
    <span id="record-status">Idle</span>
    <button id="inspect-webview">Inspect Webview</button>
    <input id="url-bar" type="text" placeholder="Enter URL or search..." style="width:60%"/>
    <button id="go-button">Go</button>
    <button id="open-sessions" title="Show saved sessions" style="margin-left:10px;">Sessions</button>
    <button id="toggle-highlighter" style="margin-left:10px;">Toggle Highlight</button>
</div>

<webview
        id="main-webview"
        src="https://www.example.com/"
        preload="webview/preload-highlighter.js"
        partition="persist:proxy-session"
        style="width:100vw;height:100vh;border:none"
        useragent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
></webview>

<!-- Simple Modal -->
<dialog id="sessions-dialog" style="width:600px;max-height:80vh;padding:20px;border-radius:8px;">
    <h3>Saved Sessions</h3>
    <div id="sessions-list" style="margin-top:10px;overflow-y:auto;max-height:60vh;"></div>
    <button id="close-sessions" style="margin-top:15px;">Close</button>
</dialog>

<script>
    const webview = document.getElementById("main-webview");
    const urlBar = document.getElementById("url-bar");
    const goButton = document.getElementById("go-button");
    const homeButton = document.getElementById("home");

    const recordBtn = document.getElementById("record-button");
    const recordStatus = document.getElementById("record-status");
    let isRecording = false;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–º–∞—à–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    homeButton.addEventListener("click", () => {
        webview.src = "https://www.example.com/";
    });

    // –ö–Ω–æ–ø–∫–∞ Go
    goButton.addEventListener("click", () => {
        navigate(urlBar.value);
    });

    // Enter –≤ –ø–æ–∏—Å–∫–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
    urlBar.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            navigate(urlBar.value);
        }
    });

    function navigate(input) {
        let url = input.trim();
        if (!url) return;

        // –ï—Å–ª–∏ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ URL ‚Äî –¥–µ–ª–∞–µ–º –ø–æ–∏—Å–∫
        if (!/^https?:\/\//i.test(url)) {
            if (url.includes(".")) {
                url = "https://" + url; // –¥–æ–º–µ–Ω –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
            } else {
                url = "https://duckduckgo.com/?q=" + encodeURIComponent(url);
            }
        }
        webview.src = url;
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
    webview.addEventListener("did-navigate", (e) => {
        urlBar.value = e.url;
    });

    webview.addEventListener("did-start-navigation", (e) => {
        console.log("Loading:", e.url);
    });

    webview.addEventListener("did-fail-load", (e) => {
        console.error("Error:", e.errorCode, e.errorDescription);
        if (e.errorCode === -3 || e.errorCode === -105) {
            webview.src = "https://duckduckgo.com/?q=test";
        }
    });
    document.getElementById("inspect-webview").addEventListener("click", () => {
        webview.openDevTools();
    });

    // --- Start / Stop recording button logic ---
    recordBtn.addEventListener("click", async () => {
        if (!isRecording) {
            // START
            isRecording = true;
            recordBtn.textContent = "‚èπ Stop";
            recordBtn.classList.remove("idle");
            recordBtn.classList.add("recording");
            recordStatus.textContent = "Recording‚Ä¶";
            urlBar.disabled = true;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Å–µ—Å—Å–∏–∏ ‚Äî –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å UI prompt –∏–ª–∏ —Ñ–æ—Ä–º—É
            let sessionName = await webview.executeJavaScript('document.title', true);
            const currentUrl = webview.getURL ? webview.getURL() : urlBar.value || '';

            // –í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ exposeInMainWorld API (preload.js)
            try {
                const result = await window.electronAPI.sessionManagement.openSession(sessionName, currentUrl);
                if (result?.success) {
                    urlBar.disabled = true;
                    goButton.disabled = true;
                    homeButton.disabled = true;

                    console.log("Session started:", sessionName);
                    webview.reloadIgnoringCache();
                } else {
                    console.error("Failed to start session:", result?.error);
                }
            } catch (err) {
                console.error('Failed to start session', err);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º UI
                isRecording = false;
                recordBtn.textContent = "‚è∫ Start";
                recordBtn.classList.remove("recording");
                recordBtn.classList.add("idle");
                recordStatus.textContent = "Idle (error)";
                urlBar.disabled = false;
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å: ' + (err && err.message ? err.message : String(err)));
            }

        } else {
            // STOP
            isRecording = false;
            recordBtn.textContent = "‚è∫ Start";
            recordBtn.classList.remove("recording");
            recordBtn.classList.add("idle");
            recordStatus.textContent = "Stopping‚Ä¶";

            try {
                const result = await window.electronAPI.sessionManagement.closeSession();
                console.log('Session stopped', result);
                recordStatus.textContent = "Saved";
                // –æ–±–Ω–æ–≤–ª—è–µ–º UI: —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º URL
                urlBar.disabled = false;

                // –ü–æ–∫–∞–∂–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ toast)
                setTimeout(() => { recordStatus.textContent = "Idle"; }, 1500);

            } catch (err) {
                console.error('Failed to stop session', err);
                recordStatus.textContent = "Error stopping";
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å: ' + (err && err.message ? err.message : String(err)));
                urlBar.disabled = false;
            }
        }
    });
</script>
<script>
    const openSessionsButton = document.getElementById("open-sessions");
    const sessionsDialog = document.getElementById("sessions-dialog");
    const sessionsList = document.getElementById("sessions-list");
    const closeSessionsButton = document.getElementById("close-sessions");
    const toggleHighlighterButton = document.getElementById("toggle-highlighter");

    openSessionsButton.addEventListener("click", async () => {
        try {
            const result = await window.electronAPI.sessionManagement.listSessions();
            const sessions = result.sessionList
            sessionsList.innerHTML = "";
            console.log(sessions)
            if (sessions.length === 0) {
                sessionsList.innerHTML = "<p>No saved sessions yet.</p>";
            } else {
                for (const session of sessions) {
                    const div = document.createElement("div");
                    div.className = "session-item";
                    div.style = "padding:8px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center;";

                    const info = document.createElement("div");
                    info.innerHTML = `
                        <strong>${session.name}</strong><br>
                        <small>${new Date(session.createTime).toLocaleString()} ‚Äî <a href="${session.url}" target="_blank">${session.url}</a></small>
                    `;

                    const buttons = document.createElement("div");
                    buttons.style = "display:flex;gap:8px;";

                    // üîπ Replay button
                    const replayBtn = document.createElement("button");
                    replayBtn.textContent = "‚ñ∂ Replay";
                    replayBtn.title = "Replay this session";
                    replayBtn.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        let replaySessionResponse = await window.electronAPI.sessionManagement.replaySession(session.id);
                        let replaySession = replaySessionResponse.session;
                        console.log("Replaying session:", replaySession);
                        webview.src = replaySession.firstPageUrl;
                        sessionsDialog.close();
                    });

                    // üîπ Open button (navigate directly)
                    const openBtn = document.createElement("button");
                    openBtn.textContent = "Open";
                    openBtn.title = "Open session URL";
                    openBtn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        navigate(session.url);
                        sessionsDialog.close();
                    });

                    buttons.appendChild(replayBtn);
                    buttons.appendChild(openBtn);
                    div.appendChild(info);
                    div.appendChild(buttons);
                    sessionsList.appendChild(div);
                }
            }
            sessionsDialog.showModal();
        } catch (err) {
            console.error("Failed to load sessions:", err);
        }
    });

    closeSessionsButton.addEventListener("click", () => sessionsDialog.close());

    toggleHighlighterButton.addEventListener("click", () => {
        webview.executeJavaScript(
            "window.__chimeraHighlighterToggle && window.__chimeraHighlighterToggle();"
        );
    });
</script>
</body>
</html>
